# 缓存与数据库的双写一致性

>先删除缓存，再更新数据库 如果此时，大量的请求过来，key中没有数据。数据库被打死了。。这种情况下的缓存击穿，有什么比较好的方式。

> 答：
>> 先从缓存拿，没缓存去获取分布式锁，获取到锁的请求去数据库拿数据
   并设到缓存，然后释放锁并返回数据；获取锁失败的请求sleep一段时间， 
   这个时间需要大于查库的时间20ms左右，然后去获取缓存，如果还是空的就去从库里获取

>评论 
>> 这个在数据量不大，并发不太高的情况下是个不错的方案。并发高的数据量大的情况下，获取锁的读库加载缓存，其他降级返回。不可能等




只要使用缓存，一定存在一致性问题(存在缓存同步窗口)，如果非要一致性，那么就使用分布式锁限制。关于缓存的使用一定要结合具体场景，不是说有的都适合缓存。典型的cap不能同时满足
如果主从延迟比较高，延迟双删是有必要的

理论上的方案。

用缓存本来就只能最终一致，要保证强一致的话，使用分布式读写锁也不是不行，就是读写性能差些

